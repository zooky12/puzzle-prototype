<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8"/>
  <title>Box-Enter Puzzle - Modular</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      color-scheme: dark;
      --bg-gradient: linear-gradient(135deg, #0a1328 0%, #132a54 42%, #341f63 100%);
      --text-primary: #e6e9ff;
      --text-muted: rgba(230, 233, 255, 0.7);
      --card-bg: rgba(11, 16, 33, 0.78);
      --card-border: rgba(255, 255, 255, 0.12);
      --input-bg: rgba(8, 12, 28, 0.7);
      --button-bg: rgba(255, 255, 255, 0.06);
      --button-border: rgba(255, 255, 255, 0.2);
      --button-hover: rgba(255, 255, 255, 0.14);
      --highlight: linear-gradient(135deg, #5f79ff 0%, #3c9dff 100%);
      --highlight-border: rgba(99, 132, 255, 0.65);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 48px 24px 64px;
    }
    .app-shell {
      width: min(1180px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .app-header { display:flex; justify-content:space-between; align-items:flex-start; }
    .app-title { margin:0; font-size:32px; font-weight:700; letter-spacing:-0.02em; }
    .tagline { margin:6px 0 0; font-size:15px; color: var(--text-muted); max-width:520px; }
    .main-grid { display:grid; gap:24px; grid-template-columns: minmax(0, 520px) minmax(0, 1fr); align-items:start; }
    @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 18px 48px rgba(0, 12, 40, 0.45);
      backdrop-filter: blur(16px);
    }
    .stage-card { display:flex; flex-direction:column; align-items:center; gap:16px; }
    #game {
      width:100%;
      max-width:480px;
      border-radius:16px;
      border:1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 6, 20, 0.48);
      image-rendering: pixelated;
    }
    #bigMessage {
      font-size:24px;
      font-weight:600;
      text-align:center;
      min-height:44px;
      color: var(--text-primary);
      letter-spacing:0.01em;
      padding:14px 18px;
      border-radius:16px;
      border:1px solid rgba(255, 255, 255, 0.12);
      background: rgba(8, 12, 28, 0.65);
      box-shadow: 0 18px 38px rgba(5, 14, 42, 0.35);
      opacity:0;
      transform: translateY(-6px);
      transition: opacity 180ms ease, transform 220ms ease, box-shadow 220ms ease;
      backdrop-filter: blur(12px);
    }
    #bigMessage.active {
      opacity:1;
      transform: translateY(0);
    }
    #bigMessage.win {
      background: linear-gradient(135deg, rgba(57, 189, 148, 0.25), rgba(23, 132, 196, 0.2));
      border-color: rgba(96, 230, 168, 0.55);
      box-shadow: 0 22px 48px rgba(36, 177, 150, 0.4);
      color:#62f2c1;
    }
    #bigMessage.lose {
      background: linear-gradient(135deg, rgba(232, 82, 82, 0.28), rgba(171, 52, 102, 0.22));
      border-color: rgba(255, 107, 107, 0.6);
      box-shadow: 0 22px 48px rgba(209, 69, 110, 0.42);
      color:#ff8f9b;
    }
    .play-controls { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; width:100%; }
    .info-panel { width:100%; background: rgba(12, 18, 40, 0.7); border:1px solid rgba(255, 255, 255, 0.1); border-radius:14px; padding:12px 16px; color: var(--text-primary); box-shadow: 0 14px 34px rgba(5, 14, 42, 0.28); backdrop-filter: blur(12px); }
    .info-panel summary { cursor:pointer; list-style:none; font-weight:600; display:flex; align-items:center; justify-content:space-between; gap:12px; font-size:15px; letter-spacing:0.01em; }
    .info-panel summary::marker { display:none; }
    .info-panel summary::after { content:'▾'; font-size:16px; transition: transform 160ms ease; color: var(--text-muted); }
    .info-panel[open] summary::after { transform: rotate(-180deg); }
    .info-panel[open] summary { color:#7faaff; }
    .info-panel summary span { font-size:13px; color: var(--text-muted); font-weight:500; }
    .info-content { margin-top:14px; display:grid; gap:16px; }
    .info-section h4 { margin:0 0 6px; font-size:14px; font-weight:600; letter-spacing:0.03em; text-transform:uppercase; color: var(--text-muted); }
    .info-section ul { margin:0; padding-left:18px; display:grid; gap:6px; font-size:13px; color: var(--text-primary); }
    .info-section li { line-height:1.5; }
    .info-section dl { margin:0; display:grid; gap:8px; }
    .info-section dt { font-size:13px; font-weight:600; color:#9fb7ff; }
    .info-section dd { margin:4px 0 0 0; font-size:13px; color: var(--text-primary); line-height:1.5; }
    .control-stack { display:flex; flex-direction:column; gap:24px; }
    button, select, input {
      font: inherit;
      border-radius:12px;
      border:1px solid var(--button-border);
      background: var(--button-bg);
      color: var(--text-primary);
      padding:8px 14px;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    }
    .levels-card select {
      color: var(--text-primary);
      background: rgba(11, 16, 33, 0.82);
    }
    .levels-card select:focus {
      color:#11131d;
      background: rgba(243, 245, 255, 0.92);
    }
    .levels-card select option {
      background-color: rgba(14, 20, 38, 0.95);
      color: var(--text-primary);
    }
    button:hover, select:hover { background: var(--button-hover); }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:0.55; cursor:not-allowed; }
    select {
      min-height:40px;
      padding-right:36px;
      appearance:none;
      background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.45) 50%), linear-gradient(135deg, rgba(255,255,255,0.45) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% + 3px);
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    label {
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color: var(--text-muted);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .levels-card .levels-row { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
    .card-title { margin:0 0 8px; font-size:20px; font-weight:600; letter-spacing:-0.01em; }
    .card-subtitle { margin:2px 0 0; font-size:13px; color: var(--text-muted); }
    .build-card .hint { margin:12px 0 0; font-size:13px; color: var(--text-muted); }
    .build-controls {
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:20px;
      border-top:1px solid rgba(255,255,255,0.08);
      padding-top:18px;
    }
    .build-controls.hidden { display:none; }
    .build-groups { display:flex; flex-direction:column; gap:20px; }
    @media (min-width: 720px) { .build-groups { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:20px; } }
    .section-label { font-size:12px; text-transform:uppercase; letter-spacing:0.08em; color: var(--text-muted); margin-bottom:8px; }
    .button-grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .build-actions { display:flex; flex-wrap:wrap; gap:10px; }
    .size-controls { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .size-controls .section-label { margin-bottom:4px; }
    .size-grid { display:grid; gap:8px; grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .size-controls button { font-size:12px; padding:6px 10px; }
    .size-compact { align-self:flex-start; }
    .dir-pad { margin-top:10px; display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px; align-items:center; justify-items:center; }
    .dir-pad > button { width:100%; }
    .dir-pad .center { height:32px; }
    input[type="file"] { display:none; }
    .build-card.active { border-color: var(--highlight-border); box-shadow: 0 22px 55px rgba(62, 123, 255, 0.35); }
    #build-mode-btn { align-self:flex-start; padding:10px 18px; font-weight:600; }
    .solver-header { display:flex; justify-content:space-between; gap:16px; align-items:flex-start; }
    #toggleSolver { padding:10px 18px; font-weight:600; }
    /* Push Build and Auto buttons to the right like Solver */
    #build-mode-btn,
    #toggleAuto { margin-left:auto; align-self:center; }
    #solverPanel {
      margin-top:18px;
      border-top:1px solid rgba(255,255,255,0.08);
      padding-top:18px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    #solverPanel.hidden { display:none; }
    .solver-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .solver-grid label { gap:8px; }
    .solver-grid input { background: var(--input-bg); border:1px solid var(--button-border); border-radius:10px; padding:8px 10px; color: var(--text-primary); }
    .solver-actions { display:flex; flex-wrap:wrap; gap:10px; }
    .progress { font-size:13px; color: var(--text-muted); }
    #solutionsList { display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:4px; }
    .solutionItem {
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      padding:8px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      white-space:nowrap;
    }
    .solutionItem .solutionText { flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; min-width:0; }
    .solutionItem .solutionActions { display:flex; gap:8px; }
    .solutionItem button { margin-left:0; background: rgba(62,123,255,0.25); border-color: rgba(62,123,255,0.4); }
    .solutionItem button:hover { background: rgba(62,123,255,0.45); }
    .solutionItem.deadHeader {
      background: rgba(36, 52, 90, 0.45);
      border-color: rgba(120, 150, 255, 0.35);
      font-weight:600;
    }
    .solutionItem.deadItem {
      background: rgba(20, 26, 44, 0.55);
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.12);
    }
    /* Auto creator */
    .auto-card .solver-grid { margin-top: 8px; }
    .tile-toggle {
      margin:12px 0 0;
      background: rgba(13, 18, 36, 0.65);
      border:1px solid var(--button-border);
      border-radius:10px;
      padding:8px 12px;
      width:100%;
      text-align:left;
      font-weight:600;
      color: var(--text-primary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .tile-toggle::after {
      content:'▾';
      font-size:14px;
      transition: transform 160ms ease;
      color: var(--text-muted);
    }
    .tile-toggle[aria-expanded="true"]::after { transform: rotate(180deg); }
    .tile-toggle[aria-expanded="true"] {
      background: var(--highlight);
      border-color: var(--highlight-border);
      color:#fff;
    }
    .tile-filter-panel {
      margin-top:6px;
      background: rgba(13, 18, 36, 0.55);
      border:1px solid var(--button-border);
      border-radius:10px;
      padding:10px 12px;
    }
    .tile-filter-options {
      margin-top:8px;
      display:grid;
      gap:6px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
    /* Ensure Build dropdowns span full width like Auto Creator */
    .build-card .build-groups { display:flex !important; flex-direction:column !important; gap:20px; }
    .build-card .tile-filter-options { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .tile-chip {
      border:1px solid var(--button-border);
      background: rgba(37, 52, 92, 0.4);
      color: var(--text-primary);
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      text-transform:capitalize;
      cursor:pointer;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .tile-chip.active {
      background: var(--highlight);
      border-color: var(--highlight-border);
      color:#fff;
    }
    #autoPanel {
      margin-top:18px;
      border-top:1px solid rgba(255,255,255,0.08);
      padding-top:18px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .hidden { display:none !important; }
    #build-mode-btn.active,
    .build-controls button.active,
    #toggleSolver.active,
    #toggleAuto.active,
    .auto-card .mutate-toggle.active {
      background: var(--highlight);
      color:#fff;
      border-color: var(--highlight-border);
      box-shadow: 0 10px 26px rgba(62, 99, 255, 0.32);
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <div class="main-grid">
      <section class="card stage-card">
        <canvas id="game" width="480" height="480"></canvas>
        <div id="bigMessage"></div>
        <div class="play-controls">
          <button id="reset-btn">Reset (R)</button>
          <button id="undo-btn">Undo (E)</button>
        </div>
        <div class="card levels-card">
          <h2 class="card-title">Level Library</h2>
          <div class="levels-row">
            <label for="server-levels">Levels
              <select id="server-levels"></select>
            </label>
            <button id="load-server">Load</button>
            <button id="refresh-server">Refresh</button>
            <button id="import-btn">Import JSON</button>
            <input type="file" id="import-file" style="display:none" />
            <input id="export-name" type="text" placeholder="level.json" style="max-width:200px" />
            <button id="export-btn">Export JSON</button>
          </div>
        </div>
        <details class="info-panel">
          <summary>Game Basics <span>movement &middot; goals &middot; hazards</span></summary>
          <div class="info-content">
            <div class="info-section">
              <h4>Basic Movement</h4>
              <ul>
                <li>Use <strong>W A S D</strong> to walk one tile at a time.</li>
                <li>Walking onto a box slips you inside it; the direction you entered becomes that box's <em>entryDir</em>.</li>
                <li>While inside a box, pressing the opposite of the entryDir launches a reverse-flight glide until something blocks you.</li>
                <li><strong>Undo (E)</strong> steps backward through recent moves, even after pushes or flights.</li>
              </ul>
            </div>
            <div class="info-section">
              <h4>Win &amp; Lose</h4>
              <ul>
                <li><strong>Win</strong>: stand free on the <em>Exit</em> once every pressure plate is held down by a box.</li>
                <li><strong>Lose</strong>: ending free on a player hole or inbox on a box that fell into a hole.</li>
                <li>Reset at any time with <strong>Reset (R)</strong> to reload the saved layout.</li>
              </ul>
            </div>
            <div class="info-section">
              <h4>Core Mechanics</h4>
              <ul>
                <li>Pressure plates must stay pressed (by any box type or the player) to power exits and other devices.</li>
                <li>Spikes, sticky pads, and similar hazards may toggle, so watch for timing windows.</li>
                <li>Fragile walls crumble into floor when a box moves through them or you glide over them.</li>
                <li>Griles behave like holes for the player but support boxes, useful for routing pushes.</li>
              </ul>
            </div>
            <div class="info-section">
              <h4>Box Behavior</h4>
              <ul>
                <li><strong>Reverse flight</strong>: stepping opposite the entryDir glides you until blocked by bounds, no-fly surfaces, sticky tiles, or other boxes. Any fragile wall you pass over shatters to floor. Landing on a box drops you inside it with a new entryDir; landing on ground returns you to free mode.</li>
                <li><strong>Normal box</strong>: any non-reverse move tries to push the box one tile. Chains push if the next space is clear for boxes. Boxes that slide into holes disappear, leaving you inbox on that hole (a loss). EntryDir stays whatever it was when you entered or after the last flight.</li>
                <li><strong>Heavy box</strong>: behaves like a normal box except when moving in the entryDir into an empty space - it steps forward once and neutralizes entryDir to {0,0}. While neutralized, the next successful move in any direction re-arms entryDir to the opposite of that move; failed pushes leave it neutralized. If blocked by another box, it falls back to normal push rules with the existing entryDir. Reverse-flight and off-axis moves behave just like a normal box.</li>
                <li><strong>Chains &amp; holes</strong>: box pushes cascade through any adjacent boxes so long as the final space is open. A box that drops into a hole is removed; if it was your current box you remain inbox on the hole tile and immediately lose.</li>
              </ul>
            </div>
            <div class="info-section">
              <h4>Block Reference</h4>
              <dl>
                <dt>Floor</dt>
                <dd>Standard tile; everyone can cross.</dd>
                <dt>Wall</dt>
                <dd>Solid obstacle for both player and crates.</dd>
                <dt>Hole</dt>
                <dd>Fatal drop for the player; crates disappear when pushed in.</dd>
                <dt>Exit</dt>
                <dd>Goal tile; often opens only when linked plates are active.</dd>
                <dt>Pressure Plate</dt>
                <dd>Triggers when held down by the player or a crate; wiring depends on level logic.</dd>
                <dt>Spikes</dt>
                <dd>Damage tiles that may cycle on/off; time your steps carefully.</dd>
                <dt>Grile</dt>
                <dd>Acts like a porous grate - blocks crates but lets the player pass.</dd>
                <dt>Hole Spikes / Slim Path</dt>
                <dd>Combination hazards that restrict crate movement and can punish missteps.</dd>
              </dl>
            </div>
          </div>
        </details>
      </section>

      <section class="control-stack">
        

          <div class="card build-card">
          <div class="solver-header">
            <div>
              <h2 class="card-title">Build Tools</h2>
              <p class="card-subtitle">Switch tiles, entities, or resize the playable grid.</p>
            </div>
            <button id="build-mode-btn" aria-pressed="false">Show Build Tools</button>
          </div>
          <div class="build-controls hidden" aria-hidden="true">
            <p class="hint">Toggle Build Tools to paint tiles or place entities. Drag across the grid to paint rapidly.</p>
            <div class="build-groups">
              <div class="build-section">
                <button type="button" class="tile-toggle" data-target="buildTiles" aria-expanded="false">Tiles</button>
                <div class="tile-filter-panel hidden" id="buildTiles" aria-hidden="true">
                  <div class="tile-filter-options">
                    <button type="button" class="tile-chip" data-tile="floor" aria-pressed="false">Floor</button>
                    <button type="button" class="tile-chip" data-tile="wall" aria-pressed="false">Wall</button>
                    <button type="button" class="tile-chip" data-tile="hole" aria-pressed="false">Hole</button>
                    <button type="button" class="tile-chip" data-tile="exit" aria-pressed="false">Exit</button>
                    <button type="button" class="tile-chip" data-tile="pressurePlate" aria-pressed="false">Pressure Plate</button>
                    <button type="button" class="tile-chip" data-tile="grile" aria-pressed="false">Grile</button>
                    <button type="button" class="tile-chip" data-tile="spikes" aria-pressed="false">Spikes</button>
                    <button type="button" class="tile-chip" data-tile="holeSpikes" aria-pressed="false">Hole Spikes</button>
                    <button type="button" class="tile-chip" data-tile="slimPathFloor" aria-pressed="false">Slim Path Floor</button>
                    <button type="button" class="tile-chip" data-tile="slimPathHole" aria-pressed="false">Slim Path Hole</button>
                  </div>
                </div>
              </div>
              <div class="build-section">
                <button type="button" class="tile-toggle" data-target="buildEntities" aria-expanded="false">Entities</button>
                <div class="tile-filter-panel hidden" id="buildEntities" aria-hidden="true">
                  <div class="tile-filter-options">
                    <button type="button" class="tile-chip" data-entity="box" aria-pressed="false">Box</button>
                    <button type="button" class="tile-chip" data-entity="heavyBox" aria-pressed="false">Heavy Box</button>
                    <button type="button" class="tile-chip" data-entity="fragileWall" aria-pressed="false">Fragile Wall</button>
                    <button type="button" class="tile-chip" data-entity="player" aria-pressed="false">Player</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="build-actions">
              <button id="clear-btn">Clear</button>
              <button id="fill-floor">Fill Walls (non-reachable)</button>
              <button id="place-one">Place 1</button>
              <button id="simplify-keep" title="Simplify level (preserve dead ends)">Simplify (strict)</button>
              <button id="simplify-flex" title="Simplify level (dead ends may change)">Simplify (flex)</button>
            </div>
            <div class="size-controls">
              <div class="section-label">Resize Grid</div>
              <div class="levels-row">
                <button id="compact-grid" class="size-compact">Compact Borders</button>
                <button id="resize-add" aria-pressed="false">Add</button>
                <button id="resize-remove" aria-pressed="false">Remove</button>
              </div>
              <div class="dir-pad hidden" id="dir-pad" aria-hidden="true">
                <div></div><button id="dir-up">Up</button><div></div>
                <button id="dir-left">Left</button><div class="center"></div><button id="dir-right">Right</button>
                <div></div><button id="dir-down">Down</button><div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="card solver-card">
          <div class="solver-header">
            <div>
              <h2 class="card-title">Solver Tools</h2>
              <p class="card-subtitle">Search for solutions and replay them directly on the board.</p>
            </div>
            <button id="toggleSolver" aria-pressed="false">Show Solver</button>
          </div>
          <div id="solverPanel" class="hidden" aria-hidden="true">
            <div class="solver-grid">
              <label>Max depth
                <input id="solverMaxDepth" type="number" value="100" min="1">
              </label>
              <label>Max nodes
                <input id="solverMaxNodes" type="number" value="200000" min="100">
              </label>
              <label>Max solutions
                <input id="solverMaxSolutions" type="number" value="50" min="1">
              </label>
            </div>
            <div class="solver-actions">
              <button id="runSolver">Run Solver</button>
              <button id="stopSolver" disabled>Stop</button>
            </div>
            <div class="progress" id="solverProgress">Idle</div>
            <div id="solutionsList"></div>
          </div>
        </div>

        <div class="card auto-card">
          <div class="solver-header">
            <div>
              <h2 class="card-title">Auto Creator</h2>
              <p class="card-subtitle">Evolve the current layout into stronger puzzles.</p>
            </div>
            <button id="toggleAuto" aria-pressed="false">Show Auto Creator</button>
          </div>
          <div id="autoPanel" class="hidden" aria-hidden="true">
            <div class="solver-grid">
              <label>Max solutions
                <input id="autoMaxSolutions" type="number" value="100" min="1" />
              </label>
              <label>Min fastest steps
                <input id="autoMinFastest" type="number" value="10" min="1" />
              </label>
              <label>Min dead ends
                <input id="autoMinDeadEnds" type="number" value="0" min="0" />
              </label>
              <label>Max tiles changed
                <input id="autoMaxChanges" type="number" value="5" min="1" />
              </label>
              <label>Attempts
                <input id="autoAttempts" type="number" value="5000" min="1" />
              </label>
              <label title="Greedy tile/entity placement per mutation step">
                <input id="autoPlaceOptimally" type="checkbox" /> Place optimally
              </label>
              <label title="Use population with this probability (0..1); 0 disables">
                Use Genetic (ratio)
                <input id="genUseRatio" type="number" min="0" max="1" step="0.05" value="0" />
              </label>
              <label title="0 uniform over top; 1 always pick top">
                Parent Skew
                <input id="genSkew" type="number" min="0" max="1" step="0.05" value="0.5" />
              </label>
              <label title="Chance to crossover two parents (population attempts)">
                Crossover %
                <input id="genCrossoverPct" type="number" min="0" max="100" step="1" value="10" />
              </label>
              <label title="Override Max tiles changed for population attempts (blank = use above)">
                Pop Mutations
                <input id="genPopMaxChanges" type="number" min="1" step="1" value="2" />
              </label>
              
            </div>
            <div class="solver-actions" aria-label="Entity mutations">
              <button id="autoMovePlayer" class="mutate-toggle" aria-pressed="false">Move Player</button>
            </div>
            <button type="button" class="tile-toggle" data-target="autoTilesChange" aria-expanded="false">Tiles allowed to change</button>
            <div class="tile-filter-panel hidden" id="autoTilesChange" aria-hidden="true">
              <div class="solver-actions" style="margin-bottom:6px">
                <button type="button" class="select-all">Select All</button>
                <button type="button" class="deselect-all">Deselect All</button>
              </div>
              <div class="tile-filter-options">
                <button type="button" class="tile-chip active" data-value="floor" aria-pressed="true">floor</button>
                <button type="button" class="tile-chip" data-value="wall" aria-pressed="false">wall</button>
                <button type="button" class="tile-chip" data-value="hole" aria-pressed="false">hole</button>
                <button type="button" class="tile-chip" data-value="exit" aria-pressed="false">exit</button>
                <button type="button" class="tile-chip" data-value="pressurePlate" aria-pressed="false">pressurePlate</button>
                <button type="button" class="tile-chip" data-value="grile" aria-pressed="false">grile</button>
                <button type="button" class="tile-chip" data-value="spikes" aria-pressed="false">spikes</button>
                <button type="button" class="tile-chip" data-value="holeSpikes" aria-pressed="false">holeSpikes</button>
                <button type="button" class="tile-chip" data-value="slimPathFloor" aria-pressed="false">slimPathFloor</button>
                <button type="button" class="tile-chip" data-value="slimPathHole" aria-pressed="false">slimPathHole</button>
                <button type="button" class="tile-chip" data-value="fragileWall" aria-pressed="false">fragileWall</button>
                <button type="button" class="tile-chip" data-option="removeBoxes" aria-pressed="false">Remove Boxes</button>
              </div>
            </div>
            <button type="button" class="tile-toggle" data-target="autoTilesPlace" aria-expanded="false">Tiles allowed to place</button>
            <div class="tile-filter-panel hidden" id="autoTilesPlace" aria-hidden="true">
              <div class="solver-actions" style="margin-bottom:6px">
                <button type="button" class="select-all">Select All</button>
                <button type="button" class="deselect-all">Deselect All</button>
              </div>
              <div class="tile-filter-options">
                <button type="button" class="tile-chip active" data-value="floor" aria-pressed="true">floor</button>
                <button type="button" class="tile-chip active" data-value="wall" aria-pressed="true">wall</button>
                <button type="button" class="tile-chip active" data-value="hole" aria-pressed="true">hole</button>
                <button type="button" class="tile-chip active" data-value="exit" aria-pressed="false">exit</button>
                <button type="button" class="tile-chip active" data-value="pressurePlate" aria-pressed="true">pressurePlate</button>
                <button type="button" class="tile-chip active" data-value="grile" aria-pressed="true">grile</button>
                <button type="button" class="tile-chip active" data-value="spikes" aria-pressed="true">spikes</button>
                <button type="button" class="tile-chip active" data-value="holeSpikes" aria-pressed="true">holeSpikes</button>
                <button type="button" class="tile-chip active" data-value="slimPathFloor" aria-pressed="true">slimPathFloor</button>
                <button type="button" class="tile-chip active" data-value="slimPathHole" aria-pressed="true">slimPathHole</button>
                <button type="button" class="tile-chip active" data-value="fragileWall" aria-pressed="true">fragileWall</button>
                <button type="button" class="tile-chip" data-option="placeBoxes" aria-pressed="false">Place Boxes</button>
              </div>
            </div>
            <div class="solver-actions">
              <button id="runAuto">Generate</button>
              <button id="stopAuto" disabled>Stop</button>
              <button id="autoRestore" disabled>Restore Original</button>
            </div>
            <button type="button" class="tile-toggle" data-target="scoringPanel" aria-expanded="false">Scoring Options</button>
            <div class="tile-filter-panel hidden" id="scoringPanel" aria-hidden="true">
              <div class="info-section">
                <h4>Weights</h4>
                <div class="solver-grid">
                  <label title="Fewer solutions → higher score (log-capped)">U (Uniqueness) <input id="scW_U" type="number" step="0.1" value="1.0" /></label>
                  <label title="Fraction of reachable states that are dead ends">D (Dead-End Density) <input id="scW_D" type="number" step="0.1" value="0.5" /></label>
                  <label title="Weights early dead ends more; t clamped to [0,L]">Fr (Early Frustration) <input id="scW_Fr" type="number" step="0.1" value="0.8" /></label>
                  <label title="Shortest path mapped to [L_min,L_max] window">S (Solution Depth) <input id="scW_S" type="number" step="0.1" value="1.2" /></label>
                  <label title="Entropy of per-step mechanics along a shortest path">M (Mechanic Diversity) <input id="scW_M" type="number" step="0.1" value="0.6" /></label>
                  <label title="Correlation with ideal build–climax–resolution arc">F (Flow Arc) <input id="scW_F" type="number" step="0.1" value="1.0" /></label>
                  <label title="Symmetry of the base grid (layout only)">Y (Symmetry) <input id="scW_Y" type="number" step="0.1" value="0.0" /></label>
                </div>
              </div>
              <div class="info-section">
                <h4>Bands (Hard Filters)</h4>
                <div class="solver-grid">
                  <label title="Discard if uniqueness outside [min,max]"><input id="scB_U_en" type="checkbox" /> U min <input id="scB_U_min" type="number" min="0" max="1" step="0.01" value="0.01" /> max <input id="scB_U_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if D outside [min,max]"><input id="scB_D_en" type="checkbox" /> D min <input id="scB_D_min" type="number" min="0" max="1" step="0.01" value="0" /> max <input id="scB_D_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if Fr outside [min,max]"><input id="scB_Fr_en" type="checkbox" /> Fr min <input id="scB_Fr_min" type="number" min="0" max="1" step="0.01" value="0" /> max <input id="scB_Fr_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if S outside [min,max]"><input id="scB_S_en" type="checkbox" /> S min <input id="scB_S_min" type="number" min="0" max="1" step="0.01" value="0.01" /> max <input id="scB_S_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if M outside [min,max]"><input id="scB_M_en" type="checkbox" /> M min <input id="scB_M_min" type="number" min="0" max="1" step="0.01" value="0" /> max <input id="scB_M_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if F outside [min,max]"><input id="scB_F_en" type="checkbox" /> F min <input id="scB_F_min" type="number" min="0" max="1" step="0.01" value="0" /> max <input id="scB_F_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                  <label title="Discard if Y outside [min,max]"><input id="scB_Y_en" type="checkbox" /> Y min <input id="scB_Y_min" type="number" min="0" max="1" step="0.01" value="0" /> max <input id="scB_Y_max" type="number" min="0" max="1" step="0.01" value="1" /></label>
                </div>
              </div>
              <div class="info-section">
                <h4>Params</h4>
                <div class="solver-grid">
                  <label title="Cap for solutions in U"><span>U · S_max</span> <input id="scP_U_Smax" type="number" min="1" step="1" value="16" /></label>
                  <label title="Desired shortest-length lower bound"><span>S · L_min</span> <input id="scP_S_Lmin" type="number" min="1" step="1" value="8" /></label>
                  <label title="Desired shortest-length upper bound"><span>S · L_max</span> <input id="scP_S_Lmax" type="number" min="2" step="1" value="30" /></label>
                  <label title="Dead-end proximity horizon (fixed at 1)"><span>F · horizon h</span> <input id="scP_F_h" type="number" min="1" max="1" step="1" value="1" /></label>
                  <label title="Ideal difficulty curve kind"><span>F · ideal</span> <select id="scP_F_kind"><option value="sine" selected>sine</option></select></label>
                  <label title="Symmetry mode for layout grid"><span>Y · mode</span> <select id="scP_Y_sym"><option value="horizontal" selected>horizontal</option><option value="vertical">vertical</option><option value="rot180">rot180</option></select></label>
                </div>
              </div>
              <div class="info-section">
                <h4>Global Constraints</h4>
                <div class="solver-grid">
                  <label title="Require every dead region to be at least this deep"><span>Min dead-end depth length</span> <input id="scG_minDedLen" type="number" min="0" step="1" value="4" /></label>
                  <label title="Discard if shortest solution length below this"><span>L_min_solvable (optional)</span> <input id="scG_LminSolv" type="number" min="0" step="1" value="0" /></label>
                </div>
              </div>
              <div class="solver-actions">
                <label style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span>Preset</span>
                  <select id="scPresetSelect">
                    <option value="generic" selected>Generic</option>
                    <option value="elegant">Elegant Campaign</option>
                    <option value="showcase">Mechanic Showcase</option>
                    <option value="exploration">Exploration</option>
                    <option value="punishing">Punishing / Frustrating</option>
                    <option value="custom">Custom</option>
                  </select>
                  <button id="scLoadPreset" type="button">Load</button>
                  <button id="scSavePreset" type="button">Save</button>
                </label>
                <button id="scResetDefaults" type="button">Reset to defaults</button>
              </div>
            </div>
            <div class="progress" id="autoProgress">Idle</div>
            <div id="autoList"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { createEmptyState, cloneState, ensurePlayerValidPosition } from './core/state.js';
    import { draw, initCanvas, animate } from './ui/canvas.js';
    import { setupBuildUI } from './ui/build.js';
    import { setupHUD } from './ui/hud.js';
    import { loadLevelList, loadLevel, exportLevel, importLevel } from './ui/io.js';
    import { stepMove } from './core/engine.js';
    import { isWinningState, isLosingState } from './core/goals.js';
    import { setupAutoUI, simplifyLevel } from './ui/auto.js';
    import { runSolver, cancelSolver } from './solver/solver.js';
    import { isTrait } from './core/tiles.js';

    // Globals (minimum for the UI)
    let state = createEmptyState(12, 12);
    let buildMode = false;
    let savedSnapshot = cloneState(state);
    let undoStack = [cloneState(state)];
    let gameState = null;

    const canvasEl = document.getElementById('game');
    initCanvas(canvasEl);

    function setGameState(type, message) {
      gameState = type;
      const el = document.getElementById('bigMessage');
      if (!el) return;

      el.classList.remove('win', 'lose', 'active');

      if (type === 'win') {
        el.textContent = message || '✨ Victory! You solved the room.';
        el.classList.add('win', 'active');
      } else if (type === 'lose') {
        el.textContent = message || '💥 Oops! Something went wrong. Try again!';
        el.classList.add('lose', 'active');
      } else {
        el.textContent = '';
      }
    }

    function refresh() { draw(state); }
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    async function refreshLevelDropdown() {
      const list = await loadLevelList();
      const sel = document.getElementById('server-levels');
      sel.innerHTML = '';
      if (!list || list.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(no levels found or index.json missing)';
        sel.appendChild(opt);
      } else {
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
      }
    }

    // HUD + keybinds
    setupHUD({
      onToggleBuildMode() {
        buildMode = !buildMode;
        const buildControls = document.querySelector('.build-controls');
        const playControls = document.querySelector('.play-controls');
        const buildBtn = document.getElementById('build-mode-btn');
        const buildCard = document.querySelector('.build-card');

        if (!buildControls || !playControls || !buildBtn) return;

        buildControls.classList.toggle('hidden', !buildMode);
        buildControls.setAttribute('aria-hidden', buildMode ? 'false' : 'true');
        playControls.classList.toggle('hidden', buildMode);
        buildControls.querySelectorAll('button, input, select').forEach(el => {
          const id = el.id || '';
          if (id === 'import-file' || id === 'import-btn' || id === 'export-btn') return; // keep import/export usable
          el.disabled = !buildMode;
        });

        buildBtn.classList.toggle('active', buildMode);
        buildBtn.setAttribute('aria-pressed', buildMode ? 'true' : 'false');
        buildBtn.textContent = buildMode ? 'Hide Build Tools' : 'Show Build Tools';
        if (buildCard) buildCard.classList.toggle('active', buildMode);

        if (!buildMode) {
          savedSnapshot = cloneState(state);
          undoStack = [cloneState(state)];
        }
        refresh();
      },
      onUndo() {
        if (undoStack.length <= 1) return;
        undoStack.pop();
        state = cloneState(undoStack[undoStack.length - 1]);
        setGameState(null);
        refresh();
      },
      onReset() {
        state = cloneState(savedSnapshot);
        undoStack = [cloneState(state)];
        setGameState(null);
        refresh();
      },
      onToggleSolver() {
        const panel = document.getElementById('solverPanel');
        const btn = document.getElementById('toggleSolver');
        if (!panel || !btn) return;
        panel.classList.toggle('hidden');
        const isOpen = !panel.classList.contains('hidden');
        panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        btn.classList.toggle('active', isOpen);
        btn.setAttribute('aria-pressed', isOpen ? 'true' : 'false');
        btn.textContent = isOpen ? 'Hide Solver' : 'Show Solver';
      },
      onRefreshLevels: refreshLevelDropdown,
      onLoadLevel: async () => {
        const sel = document.getElementById('server-levels');
        const name = sel.value;
        if (!name) return alert('Select a level first');
        try {
          const data = await loadLevel(name);
          state = data;
          ensurePlayerValidPosition(state);
          savedSnapshot = cloneState(state);
          undoStack = [cloneState(state)];
          setGameState(null);
          refresh();
        } catch (err) {
          alert('Failed to load: ' + err.message);
        }
      },
      onExport: (name) => exportLevel(state, name),
      onImport: async (file) => {
        try {
          state = await importLevel(file);
          ensurePlayerValidPosition(state);
          savedSnapshot = cloneState(state);
          undoStack = [cloneState(state)];
          setGameState(null);
          refresh();
        } catch (err) {
          alert('Failed to import: ' + err.message);
        }
      },
      onRunSolver: async ({ maxDepth, maxNodes, maxSolutions, onProgress, onSolutions }) => {
        const result = await runSolver(state, { maxDepth, maxNodes, maxSolutions, onProgress });
        onSolutions(result || { solutions: [], deadEnds: [], stats: {} });
      },
      onStopSolver: () => { cancelSolver(); },
      onPlaySolution: async (moves) => {
        if (!savedSnapshot) return alert('No saved snapshot. Enter Build mode and exit to take one.');
        state = cloneState(savedSnapshot);
        undoStack = [cloneState(state)];
        setGameState(null);
        refresh();
        await sleep(300);

        for (const ch of moves) {
          if (gameState) break;
          let dx = 0;
          let dy = 0;
          if (ch === 'w') dy = -1;
          else if (ch === 's') dy = 1;
          else if (ch === 'a') dx = -1;
          else if (ch === 'd') dx = 1;
          else continue;

          const { newState, effects, changed } = stepMove(state, { dx, dy });
          if (!changed) continue;

          state = newState;
          animate(effects);
          refresh();

          if (isLosingState(state)) { setGameState('lose', 'Game Over - fell into hole or box fell'); break; }
          if (isWinningState(state)) { setGameState('win', 'You Win!'); break; }

          await sleep(160); // playback speed
        }
      },
      onExportSolution: (moves) => {
        const data = { moves, length: moves.length };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'solution.json';
        a.click();
        URL.revokeObjectURL(url);
      }
    });

    const buildControls = document.querySelector('.build-controls');
    if (buildControls) {
      buildControls.querySelectorAll('button, input, select').forEach(el => {
        const id = el.id || '';
        if (id === 'import-file' || id === 'import-btn' || id === 'export-btn') return;
        el.disabled = true;
      });
    }

    // Build mode painting helpers
    setupBuildUI({
      canvasEl,
      getState: () => state,
      setState: (next) => { state = next; refresh(); },
      onModified: () => {},
      onSnapshot: () => { undoStack.push(cloneState(state)); },
      requestRedraw: refresh,
      isBuildMode: () => buildMode
    });

    // Auto level creator
    setupAutoUI({
      getState: () => state,
      setState: (s) => {
        state = cloneState(s);
        savedSnapshot = cloneState(state);
        undoStack = [cloneState(state)];
        setGameState(null);
        refresh();
      },
      runSolver: (s, opts) => runSolver(s, opts),
      onPlaySolution: async ({ state: previewState, moves }) => {
        if (!previewState) return;
        state = cloneState(previewState);
        savedSnapshot = cloneState(state);
        undoStack = [cloneState(state)];
        setGameState(null);
        refresh();
        await sleep(300);
        for (const ch of moves || '') {
          if (gameState) break;
          let dx=0, dy=0;
          if (ch==='w') dy=-1; else if (ch==='s') dy=1; else if (ch==='a') dx=-1; else if (ch==='d') dx=1; else continue;
          const { newState, effects, changed } = stepMove(state, { dx, dy });
          if (!changed) continue;
          state = newState; animate(effects); refresh();
          if (isLosingState(state)) { setGameState('lose', 'Game Over'); break; }
          if (isWinningState(state)) { setGameState('win', 'You Win!'); break; }
          await sleep(160);
        }
      }
    });

    // Simplify buttons (Build Tools)
    const simplifyStrictBtn = document.getElementById('simplify-keep');
    const simplifyFlexBtn = document.getElementById('simplify-flex');
    async function runSimplify(preserveDeadEnds) {
      try {
        const maxDepth = Number(document.getElementById('solverMaxDepth').value) || 100;
        const maxNodes = Number(document.getElementById('solverMaxNodes').value) || 200000;
        const maxSolutions = Number(document.getElementById('solverMaxSolutions').value) || 50;
        const params = { maxDepth, maxNodes, maxSolutions };
        const btns = [simplifyStrictBtn, simplifyFlexBtn];
        btns.forEach(b => b && (b.disabled = true));
        const simplified = await simplifyLevel(state, { runSolver: (s, opts) => runSolver(s, opts), params, preserveDeadEnds });
        if (simplified) {
          state = cloneState(simplified);
          savedSnapshot = cloneState(state);
          undoStack = [cloneState(state)];
          setGameState(null);
          refresh();
        }
      } finally {
        [simplifyStrictBtn, simplifyFlexBtn].forEach(b => b && (b.disabled = false));
      }
    }
    if (simplifyStrictBtn) simplifyStrictBtn.addEventListener('click', () => runSimplify(true));
    if (simplifyFlexBtn) simplifyFlexBtn.addEventListener('click', () => runSimplify(false));

    // Place 1: try placing the currently selected tile at every valid cell and pick the hardest result
    const placeOneBtn = document.getElementById('place-one');
    if (placeOneBtn) {
      placeOneBtn.addEventListener('click', async () => {
        // Only works in Build mode
        if (!buildMode) return alert('Enter Build Tools first (Show Build Tools).');

        // Determine selected tile from Build Tiles chips
        const activeTileBtn = document.querySelector('#buildTiles .tile-chip.active[data-tile], .build-controls .tile-chip.active[data-tile]');
        const tileType = activeTileBtn?.dataset?.tile;
        if (!tileType) return alert('Select a tile in Build Tools (Tiles dropdown) first.');

        const rows = state.size.rows;
        const cols = state.size.cols;
        // Solver limits from Solver Tools inputs
        const limits = {
          maxDepth: Number(document.getElementById('solverMaxDepth')?.value) || 100,
          maxNodes: Number(document.getElementById('solverMaxNodes')?.value) || 200000,
          maxSolutions: Number(document.getElementById('solverMaxSolutions')?.value) || 50
        };
        const status = document.getElementById('autoProgress') || document.getElementById('solverProgress');
        placeOneBtn.disabled = true;
        const prevText = status ? status.textContent : '';

        function canPlaceAt(x, y) {
          // Skip if identical
          const cur = state.base[y][x] || 'floor';
          if (cur === tileType) return false;
          // Do not place under any entity
          const anyEnt = state.entities?.some(e => e.x === x && e.y === y);
          if (anyEnt) return false;
          // If a box/heavyBox is here (should be caught above), or may be placed later, be conservative:
          // If placing a tile that blocks boxes, avoid if a box is here
          const blocksBox = isTrait(tileType, 'isWallForBox') || isTrait(tileType, 'isHoleForBox');
          if (blocksBox) {
            const hasBox = state.entities?.some(e => (e.type === 'box' || e.type === 'heavyBox') && e.x === x && e.y === y);
            if (hasBox) return false;
          }
          return true;
        }

        let best = null; // {x,y, solutions, fastest, deadEnds}
        let checked = 0;
        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < cols; x++) {
            if (!canPlaceAt(x, y)) continue;
            const test = cloneState(state);
            test.base[y][x] = tileType;
            const res = await runSolver(test, { ...limits, onProgress: () => {} });
            const sols = Array.isArray(res?.solutions) ? res.solutions : [];
            if (!sols.length) { checked++; continue; }
            const deads = Array.isArray(res?.deadEnds) ? res.deadEnds : [];
            const fastest = Math.min(...sols.map(s => s.length));

            // Hardness: maximize fastest steps; then maximize dead ends; then minimize solutions
            if (!best ||
                fastest > best.fastest ||
                (fastest === best.fastest && deads.length > best.deadEnds) ||
                (fastest === best.fastest && deads.length === best.deadEnds && sols.length < best.solutions)) {
              best = { x, y, solutions: sols.length, fastest, deadEnds: deads.length };
            }
            checked++;
            if (status && checked % 10 === 0) status.textContent = `Evaluated ${checked}/${rows*cols} cells...`;
            await new Promise(r => setTimeout(r, 0));
          }
        }

        if (best) {
          undoStack.push(cloneState(state));
          state.base[best.y][best.x] = tileType;
          setGameState(null);
          refresh();
          if (status) status.textContent = `Placed at (${best.x},${best.y}) · steps:${best.fastest} sols:${best.solutions} deads:${best.deadEnds}`;
        } else {
          if (status) status.textContent = 'No valid placement found (or none improved solvability).';
        }
        placeOneBtn.disabled = false;
        if (status && !prevText) {
          // leave the helpful result text; otherwise restore previous
        }
      });
    }

    // Gameplay controls
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      const ae = document.activeElement;
      const typing = ae && ((ae.tagName === 'INPUT' && !['button','checkbox','radio','submit','reset'].includes(ae.type)) || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
      if (typing) return; // do not steal keys while typing in inputs/textareas

      if (buildMode) {
        if (key === 'e') { e.preventDefault(); document.getElementById('undo-btn').click(); }
        if (key === 'r') { e.preventDefault(); document.getElementById('reset-btn').click(); }
        return;
      }

      let dx = 0;
      let dy = 0;
      if (key === 'w') dy = -1;
      else if (key === 's') dy = 1;
      else if (key === 'a') dx = -1;
      else if (key === 'd') dx = 1;
      else if (key === 'e') { e.preventDefault(); document.getElementById('undo-btn').click(); return; }
      else if (key === 'r') { e.preventDefault(); document.getElementById('reset-btn').click(); return; }
      else return;

      e.preventDefault();
      if (gameState) return;

      const { newState, effects, changed } = stepMove(state, { dx, dy });
      if (!changed) return;

      undoStack.push(cloneState(state));
      state = newState;
      animate(effects);
      refresh();

      if (isLosingState(state)) setGameState('lose', 'Game Over - fell into hole or box fell');
      else if (isWinningState(state)) setGameState('win', 'You Win!');
      else setGameState(null);
    });

    // Initial render and data
    refresh();
    refreshLevelDropdown();
  </script>
</body>
</html>












